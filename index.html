<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AhorroJ - Control de Ahorros</title>
  <meta name="theme-color" content="#000000" />
  <meta name="description" content="Aplicaci√≥n para registrar y seguir mis ahorros diarios." />
  <link rel="manifest" href="manifest.json" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 16px;
      color: #000;
      font-size: 1.1em;
    }
    header {
      background: #000;
      color: white;
      padding: 14px;
      text-align: center;
      font-size: 1.5em;
      font-weight: bold;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    input, button {
      width: 100%;
      padding: 14px;
      margin: 8px 0;
      font-size: 1.2em;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
    }
    button {
      background: #2e7d32;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    #clearBtn {
      background: #d32f2f;
    }
    #shareBtn {
      background: #128C7E;
    }
    .preview-box {
      background: white;
      border-radius: 10px;
      padding: 16px;
      margin-top: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .month-group {
      margin-bottom: 24px;
    }
    .month-title {
      font-size: 1.3em;
      font-weight: bold;
      color: #1b5e20;
      margin: 18px 0 12px 0;
      padding-bottom: 6px;
      border-bottom: 2px solid #e0e0e0;
    }
    .savings-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      font-size: 1.1em;
    }
    .date-text {
      font-weight: bold;
      color: #333;
    }
    .amount-text {
      color: #2e7d32;
      font-weight: bold;
    }
    .total-box {
      text-align: center;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 2px dashed #ccc;
    }
    .total-label {
      font-size: 1.2em;
      color: #d32f2f;
      font-weight: bold;
    }
    .locked-notice {
      text-align: center;
      color: #888;
      font-style: italic;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <header>AhorroJ</header>
  <div class="container">
    <input type="number" id="amount" placeholder="Ingresa tu ahorro (ej. 5000)" min="0" />
    <button id="saveBtn" onclick="saveSavings()">Guardar Ahorro de Hoy</button>
    <div id="lockedMsg" class="locked-notice"></div>

    <div class="preview-box">
      <div id="savings-preview"></div>
      <div class="total-box">
        <div class="total-label">Total Ahorrado: <span id="total-amount">0</span></div>
      </div>
    </div>

    <button id="shareBtn" onclick="shareWeeklySavings()">Compartir Resumen Semanal (s√°bados)</button>
    <button id="clearBtn" onclick="clearAllData()">Borrar Todos los Ahorros</button>
  </div>

  <script>
    const WHATSAPP_NUMBER = '+573025656771';

    function formatCOP(num) {
      return new Intl.NumberFormat('es-CO', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(num);
    }

    function getCaracasDate() {
      const now = new Date();
      const caracasTime = new Date(now.toLocaleString("en-US", { timeZone: "America/Caracas" }));
      return caracasTime;
    }

    function parseDate(dateStr) {
      const [y, m, d] = dateStr.split('-');
      return new Date(y, m - 1, d);
    }

    function dateToYYYYMMDD(date) {
      return date.toISOString().split('T')[0];
    }

    function getShortDay(date) {
      const days = ['dom', 'lun', 'mar', 'mi√©', 'jue', 'vie', 's√°b'];
      return days[date.getDay()];
    }

    function formatDateDDMMYYYY(date) {
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }

    function getMonthYear(date) {
      return date.toLocaleDateString('es-CO', { month: 'long', year: 'numeric' });
    }

    function saveSavings() {
      const input = document.getElementById('amount');
      const rawValue = input.value.trim().replace(/[^\d]/g, '');
      const value = parseInt(rawValue, 10);

      if (!rawValue || isNaN(value) || value <= 0) {
        alert("Ingresa un valor num√©rico v√°lido mayor a 0.");
        return;
      }

      const today = dateToYYYYMMDD(getCaracasDate());
      let savings = JSON.parse(localStorage.getItem('savings') || '{}');

      if (savings[today] !== undefined) {
        alert("Ya registraste un ahorro hoy. Solo se permite un ingreso por d√≠a.");
        return;
      }

      savings[today] = value;
      localStorage.setItem('savings', JSON.stringify(savings));
      input.value = '';
      renderSavings();
    }

    function clearAllData() {
      if (confirm("¬øEst√°s seguro de que deseas borrar todos los ahorros? Esta acci√≥n no se puede deshacer.")) {
        localStorage.removeItem('savings');
        renderSavings();
      }
    }

    function shareWeeklySavings() {
      const now = getCaracasDate();
      const dayOfWeek = now.getDay(); // 0 = dom, 1 = lun, ... 6 = s√°b

      if (dayOfWeek !== 6) {
        alert("Esta funci√≥n solo est√° disponible los s√°bados.");
        return;
      }

      const savings = JSON.parse(localStorage.getItem('savings') || '{}');
      if (Object.keys(savings).length === 0) {
        alert("No hay ahorros para compartir.");
        return;
      }

      // Calcular lunes de esta semana (ISO: lunes = d√≠a 1)
      const today = new Date(now);
      const day = today.getDay();
      const diff = today.getDate() - day + (day === 0 ? -6 : 1);
      const monday = new Date(today.setDate(diff));
      const saturday = new Date(monday);
      saturday.setDate(monday.getDate() + 5);

      const weeklyEntries = [];
      let weeklyTotal = 0;

      for (let dateStr in savings) {
        const dateObj = parseDate(dateStr);
        if (dateObj >= monday && dateObj <= saturday) {
          weeklyEntries.push({ dateStr, dateObj, amount: savings[dateStr] });
          weeklyTotal += savings[dateStr];
        }
      }

      if (weeklyEntries.length === 0) {
        alert("No hay ahorros registrados esta semana.");
        return;
      }

      weeklyEntries.sort((a, b) => a.dateObj - b.dateObj);

      let msg = "üí∞ *RESUMEN SEMANAL DE AHORROS*\n\n";
      weeklyEntries.forEach(entry => {
        const shortDay = getShortDay(entry.dateObj);
        const formattedDate = formatDateDDMMYYYY(entry.dateObj);
        const amount = formatCOP(entry.amount);
        msg += `${shortDay}, ${formattedDate}: ${amount}\n`;
      });
      msg += `\n‚úÖ Total ahorrado esta semana: ${formatCOP(weeklyTotal)} COP\n\n‚Äî Jeison üí™`;

      const encodedMsg = encodeURIComponent(msg);
      const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodedMsg}`;
      window.open(whatsappUrl, '_blank');
    }

    function renderSavings() {
      const savings = JSON.parse(localStorage.getItem('savings') || '{}');
      const previewEl = document.getElementById('savings-preview');
      const totalEl = document.getElementById('total-amount');
      const inputEl = document.getElementById('amount');
      const saveBtn = document.getElementById('saveBtn');
      const lockedMsg = document.getElementById('lockedMsg');
      const shareBtn = document.getElementById('shareBtn');

      const today = dateToYYYYMMDD(getCaracasDate());
      const isTodaySaved = savings[today] !== undefined;

      inputEl.disabled = isTodaySaved;
      saveBtn.disabled = isTodaySaved;
      lockedMsg.textContent = isTodaySaved ? "‚úÖ Ya registraste tu ahorro de hoy." : "";

      const now = getCaracasDate();
      const isSaturday = now.getDay() === 6;
      shareBtn.disabled = !isSaturday;

      const sortedDates = Object.keys(savings).sort((a, b) => parseDate(b) - parseDate(a));
      let total = 0;
      const groups = {};

      sortedDates.forEach(dateStr => {
        const amount = savings[dateStr];
        total += amount;
        const dateObj = parseDate(dateStr);
        const monthKey = getMonthYear(dateObj);
        if (!groups[monthKey]) groups[monthKey] = [];
        groups[monthKey].push({ dateStr, dateObj, amount });
      });

      if (sortedDates.length === 0) {
        previewEl.innerHTML = '<p>No hay ahorros registrados.</p>';
      } else {
        let html = '';
        for (const [month, items] of Object.entries(groups)) {
          html += `<div class="month-group">
                     <div class="month-title">${month}</div>`;
          items.forEach(item => {
            const shortDay = getShortDay(item.dateObj);
            const formattedDate = formatDateDDMMYYYY(item.dateObj);
            html += `
              <div class="savings-item">
                <span class="date-text">${shortDay}, ${formattedDate}</span>
                <span class="amount-text">${formatCOP(item.amount)}</span>
              </div>`;
          });
          html += `</div>`;
        }
        previewEl.innerHTML = html;
      }

      totalEl.textContent = formatCOP(total);
    }

    window.onload = () => {
      renderSavings();
    };

    // Registrar Service Worker para PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/ahorroj/service-worker.js')
          .then(reg => console.log('Service Worker registrado en:', reg.scope))
          .catch(err => console.log('Error al registrar Service Worker:', err));
      });
    }
  </script>
</body>
</html>